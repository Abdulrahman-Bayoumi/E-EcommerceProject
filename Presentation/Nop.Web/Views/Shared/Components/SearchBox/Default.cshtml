@model SearchBoxModel

@{
    const string categoryFormName = "cid";
    const string termFormName = "q";
    const string searchBoxId = "small-searchterms";
}

<style>
    #small-search-box-form {
        display: flex;
        gap: 0;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        background: white;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
        max-width: 450px;
    }
    #small-search-box-form:focus-within {
        border-color: #667eea;
        box-shadow: 0 3px 12px rgba(102, 126, 234, 0.25);
    }
    .search-box-text {
        flex: 1;
        padding: 8px 15px;
        border: none;
        outline: none;
        font-size: 13px;
        background: transparent;
    }
    .search-box-text::placeholder {
        color: #999;
    }
    .search-box-category {
        padding: 8px 12px;
        border: none;
        border-right: 1px solid #e0e0e0;
        border-left: 1px solid #e0e0e0;
        background: #f8f9fa;
        font-size: 13px;
        cursor: pointer;
        outline: none;
        max-width: 130px;
    }
    .search-box-button {
        padding: 8px 18px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .search-box-button:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: scale(1.05);
    }
    .search-box-button i {
        font-size: 14px;
    }
</style>
<form asp-route="@NopRouteNames.General.SEARCH" method="get" id="small-search-box-form">
    @if (Model.ShowSearchBox)
    {
        <input type="text" class="search-box-text" id="@searchBoxId" autocomplete="off" name="@termFormName" placeholder="@T("Search.SearchBox.Tooltip")" aria-label="@T("Search.SearchBox.Text.Label")" />
        @if(Model.ShowSearchBoxCategories)
        {
            <select asp-for="SearchCategoryId" name="@categoryFormName" asp-items="Model.AvailableCategories" class="search-box-category"></select>
            <script asp-location="Footer">
                $(function () {
                    $('#@Html.IdFor(m => m.SearchCategoryId)').on('change', function () {
                        $('#@searchBoxId').focus();
                    });
                });
            </script>
        }
        @await Component.InvokeAsync(typeof(WidgetViewComponent), new { widgetZone = PublicWidgetZones.SearchBoxBeforeSearchButton, additionalData = Model })
        <button type="submit" class="button-1 search-box-button">
            <i class="fas fa-search"></i>
            <span>@T("Search.Button")</span>
        </button>

        <script asp-location="Footer">
            $("#small-search-box-form").on("submit", function (event) {

                event.preventDefault();

                @if(Model.SearchTermMinimumLength > 0)
                {
                    <text>
                    if ($("#@searchBoxId").val() == "") {
                        alert('@Html.Raw(JavaScriptEncoder.Default.Encode(T("Search.EnterSearchTerms").Text))');
                        $("#@searchBoxId").focus();
                        return;
                    }
                    </text>
                }

                var form = document.getElementById('small-search-box-form');
                var formData = new FormData(form);

                @if(Model.ShowSearchBoxCategories)
                {
                    <text>
                    var selectedCategory = formData.get('@categoryFormName');
                    if (selectedCategory && selectedCategory != '0') {
                        formData.append('advs', true);
                        formData.append('isc', true);
                    }
                    </text>
                }

                window.location.href = `@Url.RouteUrl(NopRouteNames.General.SEARCH)?${new URLSearchParams(formData).toString()}`;
            });
        </script>

        @if (Model.AutoCompleteEnabled)
        {
            <script asp-location="Footer">
                $(function() {
                    var cache = new Map();
                    var showLinkToResultSearch;
                    var searchText;

                    $('#@searchBoxId').autocomplete({
                        delay: 500,
                        minLength: @Model.SearchTermMinimumLength,
                        source: function (request, response) {
                            var term = request.term && request.term.trim().toLowerCase();
                            var categoryElement = $('#@Html.IdFor(m => m.SearchCategoryId)');
                            var categoryId = categoryElement.length == 0 ? 0 : categoryElement.val()

                            var query = { term, categoryId };
                            var cacheKey = JSON.stringify(query);

                            if (cache.has(cacheKey)) {
                                response(cache.get(cacheKey));
                                return;
                            }

                            $.getJSON('@(Url.RouteUrl(NopRouteNames.Ajax.PRODUCT_SEARCH_AUTOCOMPLETE))', query, function (data, status, xhr) {
                                cache.set(cacheKey, data);
                                response(data);
                            });
                        },
                        appendTo: '.search-box',
                        select: function(event, ui) {
                            $("#@searchBoxId").val(ui.item.label);
                            setLocation(ui.item.producturl);
                            return false;
                        },
                        //append link to the end of list
                        open: function(event, ui) {
                            //display link to search page
                            if (showLinkToResultSearch) {
                                searchText = document.getElementById("@searchBoxId").value;
                                $(".ui-autocomplete").append("<li class=\"ui-menu-item\" role=\"presentation\"><a href=\"/search?q=" + searchText + "\">@T("Search.SearchBox.SearchPageLink")</a></li>");
                            }
                        }
                    })
                    .focus(function () {
                        $(this).autocomplete('search', $(this).val());
                    })
                    .data("ui-autocomplete")._renderItem = function(ul, item) {
                        var t = item.label;
                        showLinkToResultSearch = item.showlinktoresultsearch;
                        //html encode
                        t = htmlEncode(t);
                        imageWidth = '@(Model.AutoCompleteSearchThumbPictureSize)';
                        return $("<li></li>")
                            .data("item.autocomplete", item)
                                .append("<a>@(Model.ShowProductImagesInSearchAutoComplete ? Html.Raw("<img src='\" + item.productpictureurl + \"' width='\" + imageWidth + \"'>") : null)<span>" + t + "</span></a>")
                            .appendTo(ul);
                    };
                });
            </script>
        }
        @await Component.InvokeAsync(typeof(WidgetViewComponent), new { widgetZone = PublicWidgetZones.SearchBox, additionalData = Model })
    }
</form>